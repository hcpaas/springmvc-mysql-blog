# Dockerfile to create springmvc-mysql-blog docker image
# Base image
FROM centos:7

# install tools
RUN yum install git java-1.8.0-openjdk-devel maven -y

# install tomcat

ENV CATALINA_HOME /usr/local/tomcat
ENV PATH $CATALINA_HOME/bin:$PATH
ENV TOMCAT_VERSION 8.0.39

ADD apache-tomcat-8.0.39.tar.gz /usr/local/

RUN mkdir -p "$CATALINA_HOME" && \
    mv /usr/local/apache-tomcat-$TOMCAT_VERSION $CATALINA_HOME && \
    rm -rf $CATALINA_HOME/webapps/*

# prepare the code and files
RUN mkdir /root/springmvc-mysql-blog
COPY pom.xml /root/springmvc-mysql-blog
COPY ./src /root/springmvc-mysql-blog/src

# mvn and move to tomcat
RUN cd /root/springmvc-mysql-blog && mvn package -Dmaven.test.skip=true && cp target/blog.war /usr/local/tomcat/webapps/ROOT.war

RUN chown -R 1001:0 /usr/local/tomcat && chmod -R ug+rw /usr/local/tomcat

USER 1001

# 
WORKDIR $CATALINA_HOME
EXPOSE 8080
CMD ["catalina.sh", "run"]
